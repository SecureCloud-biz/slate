<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>dOctobat</title>

    <link href="stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" type="text/css" media="print" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
      <script src="javascripts/all_nosearch.js" type="text/javascript"></script>

      <script>
        $(function() {
          setupLanguages(["ruby"]);
        });
      </script>
  </head>

  <body class="index">
    <header style="z-index:1000;">
      <div class="container">
        <span id="brand-logo">
          <a href="https://www.octobat.com/"><img height="64px" src="images/logo.png" /></a>
        </span>
        <ul id="lp-menu">
          <li>
            <a href="https://www.octobat.com/how_it_works">How it works</a>
          </li>
          <li>
            <a href="https://www.octobat.com/team">Our team</a>
          </li>
          <li>
            <a href="https://www.octobat.com/pricing">Pricing</a>
          </li>
          <li>
            <a href="http://blog.octobat.com">Blog</a>
          </li>
        </ul>

      </div>
    </header>
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
        <div class="lang-selector">
              <a href="#" data-language-name="ruby">ruby</a>
        </div>
      <div id="toc">
      </div>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='introduction'>Introduction</h1>
<p>Welcome to the <a href="https://www.octobat.com/">Octobat</a> documentation. </p>

<p>We advice you to follow this documentation when subscribing to Octobat.</p>
<h1 id='environment'>Environment</h1>
<blockquote>
<p>Example B2B current_user object</p>
</blockquote>
<pre><code class="highlight ruby"><span class="c1">#&lt;User:0xaa48a8&gt; {</span>
  <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
  <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">"contact@octobat.com"</span><span class="p">,</span>
  <span class="ss">:business_type</span> <span class="o">=&gt;</span> <span class="s2">"B2B"</span><span class="p">,</span> <span class="c1"># or B2C but business_name will be blank</span>
  <span class="ss">:business_name</span> <span class="o">=&gt;</span> <span class="s2">"Octobat"</span><span class="p">,</span>
  <span class="ss">:first_name</span> <span class="o">=&gt;</span> <span class="s2">"Nicolas"</span><span class="p">,</span>
  <span class="ss">:last_name</span> <span class="o">=&gt;</span> <span class="s2">"Guillemain"</span><span class="p">,</span>
  <span class="ss">:address</span> <span class="o">=&gt;</span> <span class="s2">"151 rue Montmartre"</span><span class="p">,</span>
  <span class="ss">:zip_code</span> <span class="o">=&gt;</span> <span class="s2">"75002"</span><span class="p">,</span>
  <span class="ss">:city</span> <span class="o">=&gt;</span> <span class="s2">"Paris"</span><span class="p">,</span>
  <span class="ss">:country</span> <span class="o">=&gt;</span> <span class="s2">"France"</span><span class="p">,</span>
  <span class="ss">:vat_number</span> <span class="o">=&gt;</span> <span class="s2">"FR60528551658"</span><span class="p">,</span>
  <span class="ss">:customer_stripe_id</span> <span class="o">=&gt;</span> <span class="s2">"cus_5ApnZITyBNjwQ8"</span>
<span class="p">}</span>
</code></pre>

<p>Will be very helpful that you have these fields in your own database.</p>

<p><aside class="notice">
<code class="prettyprint">current_user</code> is your customer.
</aside></p>
<h1 id='requirements'>Requirements</h1>
<p>To ensure that all your invoices are correctly generated, you must follow this pattern for your Stripe API calls.</p>
<h2 id='customers-amp-cards'>Customers &amp; Cards</h2>
<blockquote>
<p>Create a new Stripe customer</p>
</blockquote>
<pre><code class="highlight ruby"><span class="k">if</span> <span class="n">customer</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="k">if</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">business_type</span> <span class="o">==</span> <span class="s2">"B2B"</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="no">Stripe</span><span class="o">::</span><span class="no">Customer</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
      <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">business_name</span><span class="p">,</span>
      <span class="ss">:metadata</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="ss">:business_type</span> <span class="o">=&gt;</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">business_type</span>
      <span class="p">}</span>
    <span class="p">)</span>
  <span class="k">else</span> <span class="c1"># for B2C</span>
    <span class="n">customer</span> <span class="o">=</span> <span class="no">Stripe</span><span class="o">::</span><span class="no">Customer</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
      <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span>
      <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">first_name</span><span class="o">+</span><span class="s2">" "</span><span class="o">+</span><span class="n">current_user</span><span class="p">.</span><span class="nf">last_name</span><span class="p">,</span>
      <span class="ss">:metadata</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="ss">:business_type</span> <span class="o">=&gt;</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">business_type</span>
      <span class="p">}</span>
    <span class="p">)</span>
  <span class="k">end</span>
  <span class="n">card</span> <span class="o">=</span> <span class="n">customer</span><span class="p">.</span><span class="nf">cards</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">card: </span><span class="n">params</span><span class="p">[</span><span class="ss">:stripeToken</span><span class="p">])</span>
  <span class="n">current_user</span><span class="p">.</span><span class="nf">update_attribute</span><span class="p">(</span><span class="ss">:customer_stripe_id</span><span class="p">,</span> <span class="n">customer</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>

<blockquote>
<p>Or retrieve the existing customer from Stripe</p>
</blockquote>
<pre><code class="highlight ruby"><span class="k">unless</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">customer_stripe_id</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="n">customer</span> <span class="o">=</span> <span class="no">Stripe</span><span class="o">::</span><span class="no">Customer</span><span class="p">.</span><span class="nf">retrieve</span><span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="nf">customer_stripe_id</span><span class="p">)</span>
  <span class="n">card</span> <span class="o">=</span> <span class="n">customer</span><span class="p">.</span><span class="nf">cards</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">card: </span><span class="n">params</span><span class="p">[</span><span class="ss">:stripeToken</span><span class="p">])</span>
<span class="k">end</span>
</code></pre>

<blockquote>
<p>Then fill the card data</p>
</blockquote>
<pre><code class="highlight ruby"><span class="k">if</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">business_type</span> <span class="o">==</span> <span class="s2">"B2B"</span>
  <span class="n">card</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">business_name</span> <span class="k">if</span> <span class="o">!</span><span class="n">current_user</span><span class="p">.</span><span class="nf">business_name</span><span class="p">.</span><span class="nf">blank?</span>
<span class="k">else</span> <span class="c1"># for B2C</span>
  <span class="n">card</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">first_name</span><span class="o">+</span><span class="s2">" "</span><span class="o">+</span><span class="n">current_user</span><span class="p">.</span><span class="nf">last_name</span> <span class="k">if</span> <span class="o">!</span><span class="n">current_user</span><span class="p">.</span><span class="nf">first_name</span><span class="p">.</span><span class="nf">blank?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">current_user</span><span class="p">.</span><span class="nf">last_name</span><span class="p">.</span><span class="nf">blank?</span>
<span class="k">end</span>

<span class="n">card</span><span class="p">.</span><span class="nf">address_line1</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">address</span> <span class="k">if</span> <span class="o">!</span><span class="n">current_user</span><span class="p">.</span><span class="nf">address</span><span class="p">.</span><span class="nf">blank?</span>
<span class="n">card</span><span class="p">.</span><span class="nf">address_city</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">city</span> <span class="k">if</span> <span class="o">!</span><span class="n">current_user</span><span class="p">.</span><span class="nf">city</span><span class="p">.</span><span class="nf">blank?</span>
<span class="n">card</span><span class="p">.</span><span class="nf">address_zip</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">zip_code</span> <span class="k">if</span> <span class="o">!</span><span class="n">current_user</span><span class="p">.</span><span class="nf">zip_code</span><span class="p">.</span><span class="nf">blank?</span>
<span class="n">card</span><span class="p">.</span><span class="nf">address_country</span> <span class="o">=</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">country</span> <span class="k">if</span> <span class="o">!</span><span class="n">current_user</span><span class="p">.</span><span class="nf">country</span><span class="p">.</span><span class="nf">blank?</span>
<span class="n">card</span><span class="p">.</span><span class="nf">save</span>
</code></pre>

<p><aside class="notice">
<code class="prettyprint">params[:stripeToken]</code> obtained with Stripe.js.
</aside></p>

<p><aside class="success">
Create any charge or subscription within the <code class="prettyprint">customer</code> object
</aside></p>
<h3 id='arguments'>Arguments</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>business_type <strong>optional</strong></td>
<td>Your setting value in Octobat</td>
<td>B2C/B2B : possible value. This is a required Octobat field to compute the VAT rate for the transaction.</td>
</tr>
</tbody></table>
<h2 id='charges'>Charges</h2><pre><code class="highlight ruby"><span class="n">charge</span> <span class="o">=</span> <span class="no">Stripe</span><span class="o">::</span><span class="no">Charge</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
  <span class="ss">:amount</span>      <span class="o">=&gt;</span> <span class="mi">400</span><span class="p">,</span>
  <span class="ss">:currency</span>    <span class="o">=&gt;</span> <span class="s2">"eur"</span><span class="p">,</span>
  <span class="ss">:card</span>        <span class="o">=&gt;</span> <span class="n">card</span><span class="p">,</span>
  <span class="ss">:customer</span>    <span class="o">=&gt;</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">customer_stripe_id</span><span class="p">,</span> <span class="c1"># or customer.id</span>
  <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s1">'The charge will appear on the invoice'</span><span class="p">,</span>
  <span class="ss">:metadata</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="ss">:vat_rate</span> <span class="o">=&gt;</span> <span class="mi">21</span><span class="p">,</span>
    <span class="ss">:eservice</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="p">}</span>
<span class="p">)</span>
</code></pre>

<p><aside class="notice">
If you already know the VAT rate and don&rsquo;t need us to compute it for you, fill the metadata :vat_rate field. Thus, you don&rsquo;t have to fill the customer <code class="prettyprint">:business_type</code> and the charge <code class="prettyprint">:eservice</code> metadata.
</aside></p>
<h3 id='arguments'>Arguments</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>vat_rate <strong>optional</strong></td>
<td>Your setting value in Octobat</td>
<td>The VAT rate of this charge.</td>
</tr>
<tr>
<td>eservice <strong>optional</strong></td>
<td>Your setting value in Octobat</td>
<td>Will be processed if :business_type equals to &ldquo;B2C&rdquo;. This is a required Octobat field to compute the VAT rate for the transaction.</td>
</tr>
</tbody></table>
<h2 id='subscriptions'>Subscriptions</h2><pre><code class="highlight ruby"><span class="n">plan</span> <span class="o">=</span> <span class="no">Stripe</span><span class="o">::</span><span class="no">Plan</span><span class="p">.</span><span class="nf">retrieve</span><span class="p">(</span><span class="s2">"octobat"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">plan</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="n">plan</span> <span class="o">=</span> <span class="no">Stripe</span><span class="o">::</span><span class="no">Plan</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
    <span class="ss">:amount</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
    <span class="ss">:interval</span> <span class="o">=&gt;</span> <span class="s1">'month'</span><span class="p">,</span>
    <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Amazing Octobat Plan'</span><span class="p">,</span>
    <span class="ss">:currency</span> <span class="o">=&gt;</span> <span class="s1">'eur'</span><span class="p">,</span>
    <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="s1">'octobat'</span>
  <span class="p">)</span>
<span class="k">end</span>

<span class="n">customer</span><span class="p">.</span><span class="nf">subscriptions</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
  <span class="ss">:plan</span> <span class="o">=&gt;</span> <span class="s2">"octobat"</span><span class="p">,</span>
  <span class="ss">:metadata</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="ss">:vat_rate</span> <span class="o">=&gt;</span> <span class="mi">21</span><span class="p">,</span>
    <span class="ss">:eservice</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="p">}</span>
<span class="p">)</span>
</code></pre>

<p>Dealing with subscriptions is like dealing with simple charges, you must fill the metadata field to provide Octobat its required data to generate perfectly your invoices.</p>
<h3 id='arguments'>Arguments</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>vat_rate <strong>optional</strong></td>
<td>Your setting value in Octobat</td>
<td>The VAT rate of this charge.</td>
</tr>
<tr>
<td>eservice <strong>optional</strong></td>
<td>Your setting value in Octobat</td>
<td>Will be processed if :business_type equals to &ldquo;B2C&rdquo;. This is a required Octobat field to compute the VAT rate for the transaction.</td>
</tr>
</tbody></table>
<h2 id='invoice-items'>Invoice items</h2><pre><code class="highlight ruby"><span class="no">Stripe</span><span class="o">::</span><span class="no">InvoiceItem</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span>
  <span class="ss">:customer</span> <span class="o">=&gt;</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">customer_stripe_id</span><span class="p">,</span> <span class="c1"># or customer.id</span>
  <span class="ss">:amount</span> <span class="o">=&gt;</span> <span class="mi">1000</span><span class="p">,</span>
  <span class="ss">:currency</span> <span class="o">=&gt;</span> <span class="s2">"eur"</span><span class="p">,</span>
  <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">"The charge will appear on the invoice"</span><span class="p">,</span>
  <span class="ss">:metadata</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="ss">:vat_rate</span> <span class="o">=&gt;</span> <span class="mi">21</span><span class="p">,</span>
    <span class="ss">:eservice</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="c1"># or false</span>
  <span class="p">}</span>
<span class="p">)</span>
</code></pre>
<h3 id='arguments'>Arguments</h3>
<table><thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>vat_rate <strong>optional</strong></td>
<td>Your setting value in Octobat</td>
<td>The VAT rate of this charge.</td>
</tr>
<tr>
<td>eservice <strong>optional</strong></td>
<td>Your setting value in Octobat</td>
<td>Will be processed if :business_type equals to &ldquo;B2C&rdquo;. This is a required Octobat field to compute the VAT rate for the transaction.</td>
</tr>
</tbody></table>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="ruby">ruby</a>
          </div>
      </div>
    </div>
  </body>
</html>
